---
layout:     post   				    # 使用的布局（不需要改）
title:      Otter(五) 				# 标题 
subtitle:   Otter如何保证数据一致性    #副标题
date:       2020-07-22 				# 时间
author:     BY lingjun						# 作者
header-img: img/post-bg-keybord.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 注意事项
---

**Otter开源版本只提供了单向回环补救算法**
![](https://i.loli.net/2020/09/23/3Q46pzqmnytdaj8.png)

适用场景： A地和B地数据不对等，比如A地为主，写入量比较高，B地有少量的数据写入<br />
<br />
**单向回环流程：(比如图中以HZ为trusted source站点)**<br />
- us->hz同步的数据，会再次进入hz->us队列，形成一次单向回环
- hz->us同步的数据，不会进入us->hz队列(回环终止，保证不进入死循环)

**存在的问题：存在同步延迟时，会出现版本丢失高/数据交替性变化**<br />
- 比如US同一条记录变更了10个版本，而且很快同步到了HZ，而HZ因为同步数据大，同步延迟，后续单向回环中将10个版本又在US进行了一次重放，导致出现数据交替
- 比如HZ同一条记录变更了10个版本，而且很快同步到了US，而US因为同步延迟，将一个比较早的版本同步到了HZ，后续通过单向回环，将此记录重放到了US，导致之前HZ到US的10个版本丢失.
**解决方案**：<br />
- 反查数据库同步 (以数据库最新版本同步，解决交替性，比如设置一致性反查数据库延迟阀值为60秒，即当同步过程中发现数据延迟超过了60秒，就会基于PK反查一次数据库，拿到当前最新值进行同步，减少交替性的问题)
- 字段同步 (降低冲突概率)
- 同步效率 (同步越快越好，降低双写导致版本丢失概率，不需要构建冲突数据KV表)
- 同步全局控制 (比如HZ->US和US->HZ一定要一起启动，一起关闭，保证不会出现一边数据一直覆盖另一边，造成比较多的版本丢失)
**同步全局控制方案：(分布式Permit)**
![](https://i.loli.net/2020/09/23/EQGdb2T1sRc9NWY.png)
注意：A,B,C三点状态都正常才允许进行同步(解决数据单向覆盖)。 任何一边的canal不正常工作，都应该停掉整个双向同步，及时性越高越好。